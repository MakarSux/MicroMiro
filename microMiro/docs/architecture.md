# Архитектура проекта MicroMiro

## Общее описание

MicroMiro - это веб-приложение для создания интерактивных досок с возможностью совместной работы, аналогичное Miro или FigJam. Приложение позволяет пользователям создавать доски, добавлять на них различные элементы (прямоугольники, круги, текст) и манипулировать ими.

## Структура проекта

Проект разделен на две основные части:
1. **Фронтенд** - клиентская часть, написанная на Vue.js 3 с использованием Composition API
2. **Бэкенд** - серверная часть, написанная на Go с использованием Gin

### Фронтенд

Фронтенд организован следующим образом:

```
src/
├── assets/           # Статические ресурсы (изображения, стили)
├── components/       # Vue компоненты
│   ├── auth/         # Компоненты аутентификации
│   ├── elements/     # Компоненты элементов доски
│   └── layout/       # Компоненты макета
├── router/           # Настройки маршрутизации
├── store/            # Хранилище состояния (Pinia)
└── views/            # Компоненты страниц
```

#### Основные компоненты

1. **Canvas.vue** - Основной компонент для работы с холстом доски
   - Отвечает за отображение и взаимодействие с элементами на доске
   - Управляет масштабированием и перемещением по холсту
   - Обрабатывает добавление, выбор и перемещение элементов

2. **AppHeader.vue** - Компонент заголовка приложения
   - Содержит логотип, навигацию и меню пользователя
   - Управляет выпадающим меню для выхода из системы

3. **BoardView.vue** - Компонент страницы доски
   - Загружает данные доски с сервера
   - Управляет сохранением изменений элементов
   - Отображает информацию о доске (название, статус сохранения)

#### Хранилище состояния

Для управления состоянием используется Pinia:

1. **canvas.js** - Хранилище для управления элементами на холсте
   - Хранит список фигур на доске
   - Предоставляет методы для добавления, обновления и удаления фигур
   - Управляет выбором активной фигуры

### Бэкенд

Бэкенд построен на фреймворке Gin и предоставляет REST API для работы с досками и элементами.

#### Основные эндпоинты API

1. **Аутентификация**
   - POST `/api/v1/register` - Регистрация нового пользователя
   - POST `/api/v1/login` - Вход в систему

2. **Профиль пользователя**
   - GET `/api/v1/protected/profile` - Получение данных профиля

3. **Управление досками**
   - GET `/api/v1/protected/boards` - Получение списка досок пользователя
   - POST `/api/v1/protected/boards` - Создание новой доски
   - GET `/api/v1/protected/boards/:id` - Получение данных конкретной доски
   - PUT `/api/v1/protected/boards/:id` - Обновление доски
   - DELETE `/api/v1/protected/boards/:id` - Удаление доски

4. **Управление элементами доски**
   - POST `/api/v1/protected/boards/:id/elements` - Добавление элемента на доску
   - PUT `/api/v1/protected/boards/:id/elements/:element_id` - Обновление элемента
   - DELETE `/api/v1/protected/boards/:id/elements/:element_id` - Удаление элемента

## Детальное описание компонентов

### Canvas.vue

Этот компонент является ядром интерактивной доски и отвечает за:

1. **Управление холстом**:
   - Масштабирование (зум)
   - Перемещение (панорамирование)
   - Отображение сетки

2. **Управление элементами**:
   - Добавление различных типов фигур (прямоугольники, круги, текст)
   - Выбор элементов
   - Перемещение элементов
   - Редактирование текстовых элементов

#### Основные функции

- `startDrag`, `onDrag`, `endDrag` - управляют перетаскиванием холста или элементов
- `handleZoom`, `zoomIn`, `zoomOut` - управляют масштабированием холста
- `addRectangle`, `addCircle`, `addText` - добавляют новые элементы на холст
- `selectShape` - выбирает элемент для редактирования
- `startEditingText`, `saveTextContent` - управляют редактированием текста

#### Особенности реализации

- Холст использует CSS-трансформации для масштабирования и перемещения
- Позиционирование элементов абсолютное, с координатами относительно холста
- Масштабирование происходит относительно позиции курсора или центра экрана

### canvas.js (Pinia Store)

Хранилище для управления состоянием холста:

```javascript
state: () => ({
  shapes: [],          // Массив всех фигур на холсте
  selectedShapeId: null // ID выбранной фигуры
}),

getters: {
  selectedShape: (state) => {
    return state.shapes.find(shape => shape.id === state.selectedShapeId);
  }
},

actions: {
  addShape(shape) { ... },      // Добавление фигуры
  updateShape(updatedShape) { ... }, // Обновление фигуры
  removeShape(shapeId) { ... },  // Удаление фигуры
  selectShape(shapeId) { ... },  // Выбор фигуры
  clearSelection() { ... },     // Очистка выбора
  setShapes(shapes) { ... },    // Установка массива фигур
  clearShapes() { ... }         // Очистка всех фигур
}
```

### BoardView.vue

Компонент страницы доски, который:

1. Загружает данные доски с сервера при монтировании
2. Отображает Canvas и передает ему начальные элементы
3. Обрабатывает события изменения элементов и отправляет их на сервер
4. Позволяет редактировать название доски
5. Отображает статус сохранения изменений

#### Основные функции

- `fetchBoard` - загружает данные доски с сервера
- `handleElementAdded`, `handleElementUpdated`, `handleElementDeleted` - обрабатывают изменения элементов и отправляют их на сервер
- `startEditingTitle`, `saveTitle` - управляют редактированием названия доски

## Особенности и ограничения

### Навигация по холсту

Навигация по холсту реализована с использованием CSS-трансформаций:

```css
transform: translate(${position.x}px, ${position.y}px) scale(${scale})
```

Это позволяет:
- Перемещаться по холсту в любом направлении (включая отрицательные координаты)
- Масштабировать холст относительно позиции курсора
- Создавать эффект бесконечного холста

### Сохранение позиций элементов

При перемещении элементов их позиции сохраняются на сервере через API-вызовы:

```javascript
await axios.put(`${API_URL}/protected/boards/${boardId}/elements/${element.id}`, element, {
  headers: {
    Authorization: `Bearer ${token}`
  }
});
```

### Выпадающее меню

Выпадающее меню в заголовке приложения реализовано с использованием состояния `showDropdown` и обработчиков событий:

```javascript
const toggleDropdown = (event) => {
  event.stopPropagation();
  showDropdown.value = !showDropdown.value;
};

const closeDropdown = (e) => {
  // Проверка, что клик был не внутри меню
  const dropdownEl = document.querySelector('.dropdown-menu');
  const userInfoEl = document.querySelector('.user-info');
  
  if (dropdownEl && dropdownEl.contains(e.target)) {
    return;
  }
  
  if (userInfoEl && userInfoEl.contains(e.target)) {
    return;
  }
  
  if (showDropdown.value) {
    showDropdown.value = false;
  }
};
```

## Возможные улучшения

1. **Сохранение позиций элементов**:
   - Отладить проблему с ошибками 400 Bad Request при обновлении элементов
   - Проверить формат данных, отправляемых на сервер

2. **Навигация по холсту**:
   - Добавить возможность перемещения с помощью клавиш стрелок
   - Реализовать функцию "вернуться к центру"

3. **Интерфейс пользователя**:
   - Улучшить обратную связь при сохранении изменений
   - Добавить уведомления об ошибках
